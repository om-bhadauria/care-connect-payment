{% extends "base.html" %}

{% block title %}Symptom Checker - CareConnect{% endblock %}

{% block content %}
<header class="text-center mb-10 mt-10">
    <h1 class="text-3xl font-normal text-gray-800 mb-2">AI Symptom Checker</h1>
    <p class="text-lg text-gray-500">Describe your symptoms and our AI assistant will provide possible insights.</p>
</header>

<div class="max-w-3xl mx-auto bg-white rounded-xl p-6 md:p-10 card-shadow space-y-6">
    <form id="symptom-checker-form">
        <div>
            <label for="symptoms-input" class="block text-lg font-medium text-gray-700 mb-2">What are your symptoms?</label>
            <textarea id="symptoms-input" rows="5" required placeholder="E.g., I have had a persistent mild fever for three days, coupled with a headache and fatigue. No vomiting or severe pain."
                class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-success focus:border-success resize-none text-base"></textarea>
        </div>
        <button type="submit" id="symptom-submit-btn" class="w-full py-3 mt-6 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-success hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-success transition duration-150 flex items-center justify-center">
            <i data-lucide="brain" class="w-5 h-5 mr-2"></i>
            Analyze Symptoms
        </button>
    </form>

    <!-- AI Results Section -->
    <div id="ai-results-card" class="hidden border border-gray-200 rounded-xl p-6 bg-gray-50 mt-8">
        <h3 class="text-xl font-semibold text-primary mb-4 flex items-center">
            <i data-lucide="bot" class="w-5 h-5 mr-2"></i>
            AI Assistant Report
        </h3>
        <div id="ai-response-content" class="text-gray-700 space-y-4">
            <!-- AI response will be injected here -->
        </div>
        <div id="ai-response-sources" class="text-xs text-gray-500 mt-4 border-t pt-3">
            <!-- Sources will be injected here -->
        </div>
    </div>
</div>

<!-- Disclaimer -->
<div class="max-w-3xl mx-auto mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
    <div class="flex items-start">
        <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-600 mr-2 mt-0.5 flex-shrink-0"></i>
        <div>
            <h4 class="font-semibold text-yellow-800">Important Disclaimer</h4>
            <p class="text-yellow-700 text-sm mt-1">This AI symptom checker is for informational purposes only and is not a substitute for professional medical advice, diagnosis, or treatment. Always seek the advice of your physician or other qualified health provider with any questions you may have regarding a medical condition.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('symptom-checker-form');
        const resultsCard = document.getElementById('ai-results-card');
        const responseContent = document.getElementById('ai-response-content');
        const sourcesDiv = document.getElementById('ai-response-sources');
        const submitBtn = document.getElementById('symptom-submit-btn');

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const symptomsText = document.getElementById('symptoms-input').value.trim();
            
            if (!symptomsText) {
                showMessage('Please describe your symptoms', 'error');
                return;
            }

            if (symptomsText.length < 10) {
                showMessage('Please provide more detailed symptoms (at least 10 characters)', 'error');
                return;
            }

            // UI Feedback: Loading State
            resultsCard.classList.remove('hidden');
            responseContent.innerHTML = `<div class="flex items-center justify-center py-12 text-primary font-medium">
                <i data-lucide="loader" class="w-6 h-6 mr-3 animate-spin"></i> 
                <div>
                    <div>Analyzing your symptoms with AI...</div>
                    <div class="text-sm text-gray-500 font-normal mt-1">This may take a few seconds</div>
                </div>
            </div>`;
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50');
            lucide.createIcons();

            try {
                const response = await fetch('/api/analyze-symptoms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ symptoms: symptomsText })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Format the markdown response
                    const formattedContent = formatMarkdownResponse(result.analysis);
                    responseContent.innerHTML = formattedContent;
                    
                    sourcesDiv.innerHTML = `
                        <div class="flex items-center text-xs text-gray-500">
                            <i data-lucide="bot" class="w-3 h-3 mr-1"></i>
                            Analysis powered by Google Gemini AI • ${new Date().toLocaleString()}
                        </div>
                    `;
                    
                    showMessage('Symptom analysis complete!', 'success');
                } else {
                    responseContent.innerHTML = `
                        <div class="text-center py-8">
                            <i data-lucide="alert-triangle" class="w-12 h-12 text-yellow-500 mx-auto mb-4"></i>
                            <h4 class="font-semibold text-gray-800 mb-2">Analysis Unavailable</h4>
                            <p class="text-gray-600">${result.analysis || 'Unable to analyze symptoms at this time.'}</p>
                            <button onclick="window.location.reload()" class="mt-4 text-primary hover:underline">
                                Try Again
                            </button>
                        </div>
                    `;
                    sourcesDiv.innerHTML = '';
                    showMessage('Analysis failed. Please try again.', 'error');
                }
            } catch (error) {
                console.error("Analysis error:", error);
                responseContent.innerHTML = `
                    <div class="text-center py-8">
                        <i data-lucide="wifi-off" class="w-12 h-12 text-red-500 mx-auto mb-4"></i>
                        <h4 class="font-semibold text-gray-800 mb-2">Connection Error</h4>
                        <p class="text-gray-600">Unable to connect to the analysis service. Please check your internet connection.</p>
                    </div>
                `;
                sourcesDiv.innerHTML = '';
                showMessage('Connection error. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50');
                lucide.createIcons();
            }
        });

        // Function to format markdown response
        function formatMarkdownResponse(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/\*(.*?)\*/g, '<em>$1</em>') // Italic
                .replace(/## (.*?)(?=\n|$)/g, '<h3 class="text-lg font-semibold text-gray-800 mt-6 mb-3">$1</h3>') // Headers
                .replace(/- (.*?)(?=\n|$)/g, '<li class="flex items-start mb-2"><span class="text-primary mr-2 mt-1">•</span><span>$1</span></li>') // List items
                .replace(/\n/g, '<br>') // Line breaks
                .replace(/(\d+\.\s)(.*?)(?=\n|$)/g, '<li class="mb-2">$1$2</li>') // Numbered lists
        }
    });
</script>
{% endblock %}